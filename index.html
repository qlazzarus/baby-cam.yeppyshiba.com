<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Baby Monitor – Supabase Login</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:720px;margin:40px auto;padding:0 16px;line-height:1.5}
    button{padding:8px 12px;margin-right:8px}
    .muted{color:#666;font-size:14px}
    .row{margin:16px 0}
    code{background:#f4f4f4;padding:2px 6px;border-radius:4px}
    a#play{display:inline-block;margin-top:8px}
  </style>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // TODO: 본인 프로젝트 값으로 교체
    const SUPABASE_URL  = "https://nandcdgybdfxkvpdgltn.supabase.co"; // <- 바꾸기
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hbmRjZGd5YmRmeGt2cGRnbHRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjAzMDcsImV4cCI6MjA3MzkzNjMwN30.kx_8neOyH4t-qiPVXZZzM3aDRQUzLJ7CenIQiTek2Tc"; // <- 바꾸기(anon 키는 클라이언트에 노출 OK)
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const els = {};
    const $ = id => (els[id] ||= document.getElementById(id));

    async function ensureSessionFromRedirect() {
      // OAuth 리디렉트로 돌아올 때 ?code=... → 세션 교환
      const qp = new URLSearchParams(window.location.search);
      if (qp.has("code")) {
        const { error } = await supabase.auth.exchangeCodeForSession({ currentUrl: window.location.href });
        if (error) console.error("exchangeCodeForSession error:", error);
        // 주소창 정리
        history.replaceState({}, "", window.location.origin + window.location.pathname);
      }
    }

    function setUIForSession(session) {
      if (!session) {
        $('status').textContent = "로그인되지 않음";
        $('jwt').textContent = "-";
        $('play-webrtc').removeAttribute('href');
        $('play-webrtc').textContent = "▶ WebRTC (로그인 필요)";
        $('play-hls').removeAttribute('href');
        $('play-hls').textContent = "▶ HLS (로그인 필요)";
        return;
      }

      // ★ 여기서 꼭 Supabase의 access_token 사용
      const jwt = session.access_token;

      $('status').textContent = "로그인됨";
      $('jwt').textContent = jwt.length > 90 ? jwt.slice(0, 90) + "..." : jwt;

      // WebRTC(권장): 8889 → baby.yeppyshiba.com
      const webrtcUrl = `https://baby.yeppyshiba.com/webrtc/?publish=false&path=baby&token=${encodeURIComponent(jwt)}`;
      $('play-webrtc').href = webrtcUrl;
      $('play-webrtc').textContent = "▶ 스트림 열기 (WebRTC)";

      // HLS(서브도메인): 8888 → hls-baby.yeppyshiba.com
      // index.m3u8 자체와 각 세그먼트 요청에도 토큰이 필요할 수 있어 플레이어에 따라 처리 필요.
      const hlsUrl = `https://hls-baby.yeppyshiba.com/baby/index.m3u8?token=${encodeURIComponent(jwt)}`;
      $('play-hls').href = hlsUrl;
      $('play-hls').textContent = "▶ 스트림 열기 (HLS)";
    }

    async function showSession() {
      const { data: { session } } = await supabase.auth.getSession();
      setUIForSession(session);
    }

    async function loginGoogle() {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: window.location.href } // 현재 페이지로 복귀
      });
      if (error) alert(error.message);
      // 브라우저가 Supabase로 이동 → 구글 로그인 → 이 페이지로 복귀
    }

    async function logout() {
      await supabase.auth.signOut();
      await showSession();
    }

    // 초기화
    window.addEventListener("DOMContentLoaded", async () => {
      // 리다이렉트 처리 → 세션 반영
      await ensureSessionFromRedirect();
      await showSession();

      // 세션 자동갱신/상태변경 이벤트
      supabase.auth.onAuthStateChange((_event, session) => {
        setUIForSession(session);
      });

      // 버튼 바인딩
      $('btn-google').addEventListener('click', loginGoogle);
      $('btn-logout').addEventListener('click', logout);
    });
  </script>
</head>
<body>
  <h1>Baby Monitor – 로그인</h1>

  <div class="row">
    <button id="btn-google">Google 로그인</button>
    <button id="btn-logout">로그아웃</button>
  </div>

  <div class="row">
    <div><strong>상태:</strong> <span id="status">확인 중...</span></div>
    <div class="muted">JWT(일부): <code id="jwt">-</code></div>
  </div>

  <div class="row">
    <a id="play-webrtc" target="_blank" rel="noopener">▶ WebRTC</a><br/>
    <a id="play-hls" target="_blank" rel="noopener">▶ HLS</a>
    <div class="muted">링크는 로그인 후 활성화됩니다.</div>
  </div>

  <hr/>
  <p class="muted">
    GitHub Pages에 배포하면, Supabase Auth의 <em>Site URL</em> / <em>Redirect URLs</em>에
    해당 페이지 URL(예: <code>https://&lt;user&gt;.github.io/&lt;repo&gt;/</code>)을 등록하세요.
  </p>
</body>
</html>
